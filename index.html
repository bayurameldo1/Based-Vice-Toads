<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Based Vice Toads â€” Mint & Claim</title>
  <link rel="icon" href="https://vice-toads.vercel.app/images/icon.png" />

  <meta name="fc:miniapp" content='{
    "version":"next",
    "imageUrl":"https://vice-toads.vercel.app/images/bg1.jpg",
    "button":{
        "title":"Mint Now",
        "action":{
        "type":"launch_miniapp",
        "name":"Based Vice Toads",
        "url":"https://vice-toads.vercel.app"
        }
    }
  }' />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap');
    :root{
      --bg-pink:#17000b;--accent:#00f2d6;--pink-1:#ff6fb3;
      --card1:#ffb6d7;--card2:#ff8fca;--box-blue:#2f9fff;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#1a0316 0%,#2b021f 60%,#1a0316 100%);
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#fff;overflow-x:hidden;}
    .wrap{max-width:980px;margin:0 auto;padding:12px;position:relative;z-index:3;}
    .marquee{overflow:hidden;white-space:nowrap;padding:6px 0;text-align:center;color:#0ab7ff;font-weight:700;font-size:14px;}
    .marquee .inner{display:inline-block;padding-left:100%;animation:marqueeAnim 10s linear infinite}
    @keyframes marqueeAnim{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
    .hero{position:relative;width:100%;height:380px;border-radius:10px;overflow:hidden;margin-top:8px;box-shadow:0 18px 60px rgba(0,0,0,.7);background:#000;}
    .hero-bg{position:absolute;inset:0;background-image:url('https://vice-toads.vercel.app/images/bg1.jpg');
      background-size:cover;background-position:center;}
    .floating-connect{position:fixed;right:28px;bottom:28px;background:linear-gradient(135deg,var(--pink-1),#ff8fca);
      color:#111;border:none;border-radius:50px;padding:14px 22px;font-weight:800;box-shadow:0 0 20px rgba(255,111,179,0.5);
      cursor:pointer;z-index:50;transition:all .25s ease;animation:float 2.8s ease-in-out infinite;display:none;}
    .floating-connect:hover{transform:scale(1.06);box-shadow:0 0 28px rgba(255,111,179,0.65);}
    @keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
    .card{width:92%;max-width:420px;margin:18px auto;padding:16px;border-radius:12px;
      background:linear-gradient(180deg,var(--card1),var(--card2));color:#071018;
      box-shadow:0 14px 40px rgba(0,0,0,.48)}
    .card .row{display:flex;align-items:center;gap:12px}
    .avatar{width:56px;height:56px;border-radius:50%;overflow:hidden;background:#fff;flex:0 0 56px}
    .avatar img{width:56px;height:56px;object-fit:cover}
    .name{font-weight:800}.sub{font-size:12px;color:#071018;opacity:.7}
    .points{font-weight:900;font-size:20px;margin-top:10px}
    .claim-row{display:flex;gap:10px;margin-top:12px;align-items:center}
    .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800;transition:all .3s ease;}
    .btn-claim{background:rgba(11,7,16,.18);color:#fff;min-width:140px;}
    .btn-connect-inline{background:#071018;color:var(--card1);padding:10px 12px;border-radius:10px;border:none;
      font-weight:800;cursor:pointer}
    .disabled{opacity:.45;pointer-events:none}
    .mint-section{display:flex;flex-direction:column;align-items:center;justify-content:center;margin-top:18px}
    .title{font-size:28px; letter-spacing:2px;margin:0;color:#ffd6ec;text-shadow:0 6px 18px rgba(0,0,0,.6);
      text-transform:none;font-weight:900;display:flex;justify-content:center;gap:6px;pointer-events:none}
    .title span{display:inline-block;transform-origin:center;animation:waveLetter 1.05s ease-in-out infinite}
    @keyframes waveLetter{0%{transform:translateY(0px)}25%{transform:translateY(-10px)}50%{transform:translateY(0px)}75%{transform:translateY(6px)}100%{transform:translateY(0px)}}

    .mint-btn{background:var(--pink-1);border-radius:28px;padding:12px 28px;border:none;color:#071018;font-weight:800;
      cursor:pointer;box-shadow:0 8px 30px rgba(255,111,179,.12);margin-top:14px}
    .logos-row{display:flex;justify-content:center;gap:12px;margin-top:18px}
    .logo{width:48px;height:48px;border-radius:8px;overflow:hidden;background:#fff;padding:6px;display:flex;align-items:center;justify-content:center}
    .logo img{width:30px;height:30px;object-fit:contain}
    .bottom{margin-top:18px;display:flex;justify-content:center}
    .bottom img{width:220px;height:auto;border-radius:10px;object-fit:contain}

    /* ---------- BOX EFFECTS (OPTIMIZED / LIGHTER) ---------- */
    .box-bubbles,.blue-bubbles{
      position:fixed;left:0;bottom:0;width:100%;height:100vh;pointer-events:none;overflow:visible;
      z-index:1;
    }
    .box-bubbles .box{
      position:absolute;bottom:-220px;background:#ffffff;border-radius:6px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06), inset 0 -4px 8px rgba(0,0,0,0.03);
      opacity:0;display:flex;align-items:center;justify-content:center;will-change:transform,opacity;transform-origin:center;
      animation-fill-mode:forwards;
      animation-play-state: running;
    }
    .box-bubbles .box::after{content:"";width:36%;height:36%;background: var(--box-blue);border-radius:4px;}
    .blue-bubbles .b{
      position:absolute;bottom:-220px;background: linear-gradient(180deg, rgba(47,159,255,0.98), rgba(12,116,255,0.9));
      border-radius:6px;box-shadow: 0 6px 18px rgba(10,110,220,0.06), inset 0 -4px 8px rgba(0,0,0,0.03);
      opacity:0;display:flex;align-items:center;justify-content:center;will-change:transform,opacity;transform-origin:center;
      animation-fill-mode:forwards;
      animation-play-state: running;
    }
    .blue-bubbles .b::after{content:"";width:32%;height:32%;background:#fff;border-radius:4px;}
    @keyframes boxRise {
      0%{ transform: translateY(0) scale(0.92) rotate(0deg); opacity:0; }
      8%{ opacity:0.6; }
      30%{ opacity:0.95; }
      60%{ transform: translateY(-55vh) scale(1.03) rotate(6deg); opacity:0.78; }
      90%{ transform: translateY(-100vh) scale(1.06) rotate(10deg); opacity:0.36; }
      100%{ transform: translateY(-120vh) scale(1.09) rotate(14deg); opacity:0; }
    }
    @keyframes boxRiseBlue {
      0%{ transform: translateY(0) scale(0.9) rotate(0deg); opacity:0; }
      8%{ opacity:0.6; }
      30%{ opacity:0.94; }
      60%{ transform: translateY(-55vh) scale(1.02) rotate(-6deg); opacity:0.78; }
      90%{ transform: translateY(-100vh) scale(1.05) rotate(-10deg); opacity:0.36; }
      100%{ transform: translateY(-120vh) scale(1.08) rotate(-14deg); opacity:0; }
    }
    @media (max-width:520px){
      .box-bubbles, .blue-bubbles { mix-blend-mode: normal; }
      .box-bubbles .box, .blue-bubbles .b { box-shadow: 0 4px 10px rgba(0,0,0,0.04), inset 0 -2px 6px rgba(0,0,0,0.02); }
    }
  </style>
</head>
<body>
  <button id="connectFloating" class="floating-connect" style="display:none">Disconnect</button>

  <div class="wrap">
    <div class="marquee"><span class="inner">ðŸŸ¦ Join The Waitlist ðŸŸ¦ &nbsp; ðŸŸ¦ Join The Waitlist ðŸŸ¦</span></div>
    <section class="hero"><div class="hero-bg"></div></section>

    <div class="mint-section">
      <h1 class="title">
        <span style="animation-delay:0s">M</span><span style="animation-delay:0.08s">i</span><span style="animation-delay:0.16s">n</span><span style="animation-delay:0.24s">t</span><span style="animation-delay:0.32s">&nbsp;</span><span style="animation-delay:0.4s">o</span><span style="animation-delay:0.48s">n</span><span style="animation-delay:0.56s">&nbsp;</span><span style="animation-delay:0.64s">O</span><span style="animation-delay:0.72s">p</span><span style="animation-delay:0.8s">e</span><span style="animation-delay:0.88s">n</span><span style="animation-delay:0.96s">s</span><span style="animation-delay:1.04s">e</span><span style="animation-delay:1.12s">a</span>
      </h1>
      <button id="mintBtn" class="mint-btn">MINT NOW</button>
      <div class="logos-row">
        <a class="logo" href="https://farcaster.xyz/ameldoxg" target="_blank"><img src="https://vice-toads.vercel.app/images/farcaster.png" alt="farcaster" /></a>
        <a class="logo" href="https://base.app/profile/0xbres" target="_blank"><img src="https://vice-toads.vercel.app/images/baseapp.png" alt="baseapp" /></a>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="avatar"><img id="avatarImg" src="https://vice-toads.vercel.app/images/icon.png" alt="avatar" /></div>
        <div style="flex:1">
          <div class="name" id="profileName">Not connected</div>
          <div class="sub" id="profileSub">Connect wallet to show profile</div>
        </div>
      </div>

      <div class="points">+100 Vice Toads$
        <div style="font-size:12px;color:#071018;opacity:.7;margin-top:6px">Total Claimed:
          <span id="totalClaimed">0</span></div>
      </div>

      <div class="claim-row">
        <button id="claimBtn" class="btn btn-claim disabled" disabled>Claim Now</button>
        <button id="connectInline" class="btn-connect-inline">Connect Wallet</button>
      </div>

      <div style="margin-top:10px;color:#071018" id="statusText">Connect wallet to claim</div>
    </div>

    <div class="bottom"><img src="https://vice-toads.vercel.app/images/bg5.jpg" alt="bottom" /></div>
    <div style="height:18px"></div>
    <div class="marquee"><span class="inner">ðŸŸ¦ Join The Waitlist ðŸŸ¦ &nbsp; ðŸŸ¦ Join The Waitlist ðŸŸ¦</span></div>
  </div>

  <div class="box-bubbles" id="boxBubbles" aria-hidden="true"></div>
  <div class="blue-bubbles" id="blueBubbles" aria-hidden="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>

  <script>
    /* Lightweight box generator (behind UI) */
    (function createBoxes(){
      const boxContainer = document.getElementById('boxBubbles');
      const blueContainer = document.getElementById('blueBubbles');
      function makeBox(isBlue,left,size,dur,delay,rot){
        const el = document.createElement('div');
        el.className = isBlue ? 'b' : 'box';
        el.style.left = left + '%';
        el.style.width = size + 'px';
        el.style.height = size + 'px';
        el.style.borderRadius = (size>60?'8px':'6px');
        el.style.animationName = isBlue ? 'boxRiseBlue':'boxRise';
        el.style.animationDuration = dur+'s';
        el.style.animationTimingFunction = 'linear';
        el.style.animationDelay = delay+'s';
        el.style.animationIterationCount = 'infinite';
        el.style.transform = 'rotate('+rot+'deg)';
        el.style.opacity = '0';
        return el;
      }
      function rand(min,max){return Math.random()*(max-min)+min}
      function gen(container,isBlue,count){
        const sizes = {small:[12,20],medium:[28,48],large:[64,100]};
        const speeds = {fast:[6,9],medium:[10,13],slow:[14,20]};
        const sizeKeys=['small','medium','large'], speedKeys=['fast','medium','slow'];
        for(let i=0;i<count;i++){
          const sk = sizeKeys[i%sizeKeys.length], sp = speedKeys[i%speedKeys.length];
          const size = Math.floor(rand(...sizes[sk]));
          const dur = Number(rand(...speeds[sp]).toFixed(2));
          const delay = -Math.abs(rand(0,6));
          const left = rand(2,94);
          const rot = rand(-16,16);
          const el = makeBox(isBlue,left,size,dur,delay,rot);
          container.appendChild(el);
        }
      }
      boxContainer.innerHTML=''; blueContainer.innerHTML='';
      gen(boxContainer,false,8); gen(blueContainer,true,6);
      let ti=null;
      function start(){ if(ti) return; ti=setInterval(()=>{ for(let i=0;i<2;i++){ if(boxContainer.firstChild) boxContainer.removeChild(boxContainer.firstChild); if(blueContainer.firstChild) blueContainer.removeChild(blueContainer.firstChild);} gen(boxContainer,false,2); gen(blueContainer,true,1); },10000); }
      function stop(){ if(ti){ clearInterval(ti); ti=null; } }
      document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stop(); else start(); });
      start();
    })();
  </script>

  <script>
  (function(){
    const connectInline=document.getElementById('connectInline');
    const connectFloating=document.getElementById('connectFloating');
    const claimBtn=document.getElementById('claimBtn');
    const profileName=document.getElementById('profileName');
    const profileSub=document.getElementById('profileSub');
    const avatarImg=document.getElementById('avatarImg');
    const statusText=document.getElementById('statusText');
    const totalClaimedEl=document.getElementById('totalClaimed');
    const mintBtn=document.getElementById('mintBtn');
    const LS_KEY="vct_claims_v1"; const DAY_MS=24*60*60*1000;
    let provider=null,web3=null,currentAddress=null,countdownInterval=null;

    function pickInjectedProvider(){
      if(typeof window.ethereum==='undefined') return null;
      if(Array.isArray(window.ethereum.providers)){
        return window.ethereum.providers.find(p=>p.isBaseWallet||p.isCoinbaseWallet||p.isCoinbase) || window.ethereum.providers[0];
      }
      return window.ethereum;
    }
    function short(a){return a?(a.slice(0,6)+'...'+a.slice(-4)):"";}
    function setConnectedState(addr){
      currentAddress=addr.toLowerCase();
      profileName.textContent=short(currentAddress);
      profileSub.textContent='Connected';
      statusText.textContent='Ready to claim your points';
      if(claimBtn){ claimBtn.classList.remove('disabled'); claimBtn.disabled=false; claimBtn.style.color='#000'; } /* connected -> black text */
      if(connectInline) connectInline.style.display='none';
      if(connectFloating){ connectFloating.style.display='block'; connectFloating.textContent='Disconnect'; }
      loadTotalsFor(currentAddress);
    }
    function handleDisconnect(){
      provider=null; web3=null; currentAddress=null;
      if(connectInline) connectInline.style.display='inline-block';
      if(connectFloating) connectFloating.style.display='none';
      profileName.textContent='Not connected';
      profileSub.textContent='Connect wallet to show profile';
      avatarImg.src='https://vice-toads.vercel.app/images/icon.png';
      if(claimBtn){ claimBtn.classList.add('disabled'); claimBtn.disabled=true; claimBtn.style.color='#fff'; } /* after disconnect -> show 0 and white */
      totalClaimedEl.textContent='0';
      statusText.textContent='Connect wallet to claim';
      stopCountdown();
    }
    function attachProviderListeners(p){
      if(!p||!p.on) return;
      try{
        p.on('accountsChanged', acc=>{ if(!acc||acc.length===0) handleDisconnect(); else setConnectedState(acc[0]); });
        p.on('disconnect', ()=>handleDisconnect());
        p.on('close', ()=>handleDisconnect());
      }catch(e){console.warn('provider events',e)}
    }

    async function trySilentConnect(){
      const p=pickInjectedProvider(); if(!p) return false;
      try{
        const accounts = (typeof p.request==='function') ? await p.request({method:'eth_accounts'}) : (await new Promise((res,rej)=> window.web3 && window.web3.eth.getAccounts((err,acc)=> err?rej(err):res(acc))));
        if(accounts && accounts.length>0){
          provider=p; web3=new Web3(provider);
          setConnectedState(accounts[0]);
          attachProviderListeners(provider);
          try{
            const r = await fetch('/api/farcaster?address='+accounts[0]);
            if(r.ok){ const j=await r.json().catch(()=>null); if(j && j.ok && j.profile){ const prof=j.profile; profileName.textContent = prof.username || prof.displayName || short(accounts[0]); if(prof.avatar) avatarImg.src = prof.avatar; profileSub.textContent = short(accounts[0]); } }
          }catch(e){}
          return true;
        }
      }catch(e){ console.warn('silent connect failed', e); }
      return false;
    }

    async function userConnect(){
      const p=pickInjectedProvider(); if(!p){ alert('No injected wallet found. Try opening with Base app or use WalletConnect.'); return; }
      try{
        statusText.textContent='Connect wallet';
        provider=p;
        const accounts = await provider.request({method:'eth_requestAccounts'});
        if(accounts && accounts.length>0){
          web3=new Web3(provider);
          setConnectedState(accounts[0]);
          attachProviderListeners(provider);
          try{ const r=await fetch('/api/farcaster?address='+accounts[0]); if(r.ok){ const j=await r.json().catch(()=>null); if(j && j.ok && j.profile){ const prof=j.profile; profileName.textContent = prof.username || prof.displayName || short(accounts[0]); if(prof.avatar) avatarImg.src = prof.avatar; profileSub.textContent = short(accounts[0]); } } }catch(e){}
        } else { statusText.textContent='Connect wallet'; }
      }catch(err){ console.warn('userConnect failed', err); statusText.textContent='Connect wallet'; }
    }

    function getLocalRecord(addr){ const db=JSON.parse(localStorage.getItem(LS_KEY)||'{}'); return db[addr]||{total:0,last:0,streak:0}; }
    function setLocalRecord(addr,rec){ const db=JSON.parse(localStorage.getItem(LS_KEY)||'{}'); db[addr]=rec; localStorage.setItem(LS_KEY,JSON.stringify(db)); }

    function loadTotalsFor(addr){
      const rec=getLocalRecord(addr);
      totalClaimedEl.textContent = rec.total || 0;
      if(rec.last && (Date.now()-rec.last)<DAY_MS){ startCountdown(DAY_MS-(Date.now()-rec.last), ((rec.streak||0)+1)*100); } else { stopCountdown(); statusText.textContent = 'You can claim now â€” Next +' + (((rec.streak||0)+1)*100) + ' pts'; if(currentAddress) claimBtn.style.color='#000'; }
    }

    function localClaim(){
      if(!currentAddress) return;
      const rec=getLocalRecord(currentAddress);
      const now=Date.now();
      if(rec.last && (now-rec.last)<DAY_MS){ const remain=DAY_MS-(now-rec.last); startCountdown(remain, ((rec.streak||0)+1)*100); return; }
      rec.streak=(rec.streak||0)+1; const amount = rec.streak*100; rec.total=(rec.total||0)+amount; rec.last=now; setLocalRecord(currentAddress,rec); totalClaimedEl.textContent=rec.total; statusText.textContent='Claimed +' + amount + ' â€” next claim in 24:00:00'; startCountdown(DAY_MS, ((rec.streak||0)+1)*100);
    }

    function startCountdown(msRemaining,nextAmount){ clearInterval(countdownInterval); const start=Date.now(); countdownInterval=setInterval(()=>{ const t=Math.max(0,msRemaining-(Date.now()-start)); if(t<=0){ clearInterval(countdownInterval); statusText.textContent='You can claim now â€” Next +' + nextAmount + ' pts'; return;} const h=Math.floor(t/3600000), m=Math.floor(t%3600000/60000), s=Math.floor(t%60000/1000); statusText.textContent = 'Next claim in ' + String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0') + ' â€” Next +' + nextAmount + ' pts'; },1000); }
    function stopCountdown(){ clearInterval(countdownInterval); countdownInterval=null; }

    connectInline.addEventListener('click', userConnect);
    connectFloating.addEventListener('click', async ()=>{ if(currentAddress){ handleDisconnect(); } else await userConnect(); });

    claimBtn.addEventListener('click', async ()=>{
      if(!currentAddress){ alert('Connect wallet first'); return; }
      claimBtn.disabled=true; statusText.textContent='Claim in progress...';
      try{
        const res = await fetch('/api/claim', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ address: currentAddress, amount:100 }) });
        const j = await res.json().catch(()=>null);
        if(j && j.ok){
          totalClaimedEl.textContent = j.total || getLocalRecord(currentAddress).total;
          const rec = getLocalRecord(currentAddress); rec.total = j.total || rec.total; rec.last = Date.now(); rec.streak = j.streak || rec.streak || 1; setLocalRecord(currentAddress, rec); startCountdown(DAY_MS, ((rec.streak||0)+1)*100);
          statusText.textContent = 'Claimed +' + (j.claimedAmount||100) + ' â€” next claim in 24:00:00';
        } else { localClaim(); }
      }catch(e){ localClaim(); }
      finally{ 
        claimBtn.disabled=false; 
        /* === KATAK: setelah claim, kembalikan warna Claim ke warna SEBELUM CONNECT (putih) === */
        claimBtn.style.color = '#fff';
      }
    });

    /* auto silent connect attempt */
    (async function tryAuto(){ try{ const ok = await trySilentConnect(); if(!ok){ if(connectInline) connectInline.style.display='inline-block'; if(connectFloating) connectFloating.style.display='none'; } }catch(e){console.warn(e);} })();

    /* mint button opens the specific OpenSea collection overview (user request) */
    mintBtn.addEventListener('click', ()=> window.open('https://opensea.io/collection/based-vice-toads/overview','_blank'));

    /* tell parent frame we're ready (helps Base preview) */
    window.addEventListener('load', ()=> { try{ window.parent.postMessage({ type:'miniapp.ready', origin: window.location.origin }, '*'); }catch(e){} });
    window.vct = { trySilentConnect, userConnect, handleDisconnect };
  })();
  </script>
</body>
</html>
